<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin/layout}" lang="ko">

<!-- Content Header -->
<div layout:fragment="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1><i class="fas fa-info-circle mr-2"></i>부동산정보 관리</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> 홈</a></li>
                    <li class="breadcrumb-item">시스템 관리</li>
                    <li class="breadcrumb-item active">부동산정보 관리</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div layout:fragment="content">
            <div class="row">
                <div class="col-12">
                    <div class="card card-warning card-outline">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-building mr-1"></i>
                                부동산 회사 정보
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="companyInfoForm" method="post">
                                <!-- 기본 정보 섹션 -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="businessName">상호명 <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-store"></i></span>
                                                </div>
                                                <input type="text" class="form-control" id="businessName" name="businessName" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="phoneNumber">대표 전화번호 <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                                </div>
                                                <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" placeholder="055-000-0000" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 주소 정보 섹션 -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="address">주소 <span class="text-danger">*</span></label>
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" id="postalCode" name="postalCode"
                                                       placeholder="우편번호" readonly>
                                                <div class="input-group-append">
                                                    <button class="btn btn-outline-warning" type="button" id="searchAddress">
                                                        <i class="fas fa-search"></i> 주소 검색
                                                    </button>
                                                </div>
                                            </div>
                                            <input type="text" class="form-control mb-2" id="roadAddress" name="roadAddress"
                                                   placeholder="도로명 주소" readonly required>
                                            <input type="text" class="form-control mb-2" id="jibunAddress" name="jibunAddress"
                                                   placeholder="지번 주소" readonly>
                                            <!-- Hidden field for address (roadAddress 또는 jibunAddress 값) -->
                                            <input type="hidden" id="address" name="address">
                                            <!-- Hidden fields for coordinates -->
                                            <input type="hidden" id="latitude" name="latitude">
                                            <input type="hidden" id="longitude" name="longitude">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="detailAddress">상세주소</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                                </div>
                                                <input type="text" class="form-control" id="detailAddress" name="detailAddress"
                                                       placeholder="상세 주소를 입력하세요 (예: 201호)">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="directions">찾아오는 길</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-route"></i></span>
                                                </div>
                                                <input type="text" class="form-control" id="directions" name="directions">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="faxNumber">팩스 번호</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-fax"></i></span>
                                                </div>
                                                <input type="tel" class="form-control" id="faxNumber" name="faxNumber"
                                                       placeholder="055-000-0000">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <!-- 담당자 정보 섹션 -->
                                <h5 class="mb-3">
                                    <i class="fas fa-user-tie mr-1"></i>
                                    담당자 정보
                                </h5>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="managerName">담당자 이름 <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                                </div>
                                                <input type="text" class="form-control" id="managerName" name="managerName" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="managerPosition">담당자 직급</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                                                </div>
                                                <input type="text" class="form-control" id="managerPosition" name="managerPosition">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="managerPhone">담당자 연락처 <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-mobile-alt"></i></span>
                                                </div>
                                                <input type="tel" class="form-control" id="managerPhone" name="managerPhone" placeholder="010-0000-0000" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="managerEmail">담당자 이메일</label>
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                                </div>
                                                <input type="email" class="form-control" id="managerEmail" name="managerEmail"
                                                       placeholder="manager@beomproperty.com">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="managerPhoto">담당자 사진</label>
                                            <div class="input-group">
                                                <div class="custom-file">
                                                    <input type="file" class="custom-file-input" id="managerPhoto" name="managerPhoto" accept="image/*">
                                                    <label class="custom-file-label" for="managerPhoto">파일 선택</label>
                                                </div>
                                                <div class="input-group-append">
                                                    <button class="btn btn-outline-warning" type="button" id="uploadPhoto">
                                                        <i class="fas fa-upload"></i> 업로드
                                                    </button>
                                                </div>
                                            </div>
                                            <small class="form-text text-muted">JPG, PNG 파일만 업로드 가능합니다.</small>
                                            <div id="photoPreview" class="mt-2" style="display: none;">
                                                <img id="previewImage" src="" alt="미리보기" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="float-right">
                                            <button type="button" class="btn btn-secondary mr-2" onclick="resetForm()">
                                                <i class="fas fa-undo"></i> 초기화
                                            </button>
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-save"></i> 저장하기
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
</div>

<th:block layout:fragment="scripts">
<!-- Daum Postcode API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
/*<![CDATA[*/
$(document).ready(function() {
    // 페이지 로드 시 데이터 불러오기
    loadCompanyInfo();

    // Custom file input
    $('.custom-file-input').on('change', function() {
        const fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass("selected").html(fileName);

        // 이미지 미리보기
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#previewImage').attr('src', e.target.result);
                $('#photoPreview').show();
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    // 폼 제출 처리 (AJAX API 호출)
    $('#companyInfoForm').on('submit', function(e) {
        e.preventDefault();

        // 유효성 검사
        if (!validateForm()) {
            return;
        }

        // 폼 데이터를 JSON 객체로 변환
        const companyData = {
            businessName: $('#businessName').val(),
            postalCode: $('#postalCode').val(),
            roadAddress: $('#roadAddress').val(),
            jibunAddress: $('#jibunAddress').val(),
            address: $('#address').val(),
            detailAddress: $('#detailAddress').val(),
            latitude: $('#latitude').val() ? parseFloat($('#latitude').val()) : null,
            longitude: $('#longitude').val() ? parseFloat($('#longitude').val()) : null,
            directions: $('#directions').val(),
            phoneNumber: $('#phoneNumber').val(),
            faxNumber: $('#faxNumber').val(),
            managerPosition: $('#managerPosition').val(),
            managerName: $('#managerName').val(),
            managerPhone: $('#managerPhone').val(),
            managerEmail: $('#managerEmail').val(),
            managerPhoto: $('#managerPhoto').val() || '/images/beom_logo.png'
        };

        // 로딩 상태 표시
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 저장 중...');

        // AJAX로 API 호출
        $.ajax({
            url: '/api/v1/admin/company/info',
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(companyData),
            success: function(response) {
                submitBtn.prop('disabled', false).html(originalText);

                // 성공 알림
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'success',
                        title: '저장 완료',
                        text: '부동산 정보가 성공적으로 저장되었습니다.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    $(document).Toasts('create', {
                        class: 'bg-success',
                        title: '저장 완료',
                        subtitle: '부동산 정보',
                        body: '부동산 정보가 성공적으로 저장되었습니다.',
                        autohide: true,
                        delay: 3000
                    });
                }

                // 데이터 다시 로드
                setTimeout(() => loadCompanyInfo(), 1000);
            },
            error: function(xhr, status, error) {
                submitBtn.prop('disabled', false).html(originalText);

                // 오류 알림
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: '저장 실패',
                        text: '부동산 정보 저장 중 오류가 발생했습니다.',
                    });
                } else {
                    $(document).Toasts('create', {
                        class: 'bg-danger',
                        title: '저장 실패',
                        body: '부동산 정보 저장 중 오류가 발생했습니다.',
                        autohide: true,
                        delay: 3000
                    });
                }
            }
        });
    });

    // 업로드 버튼 클릭
    $('#uploadPhoto').on('click', function() {
        $('#managerPhoto').click();
    });

    // 주소 검색 초기화
    $('#searchAddress').on('click', function() {
        new daum.Postcode({
            oncomplete: function(data) {
                // 우편번호와 주소 정보를 입력
                $('#postalCode').val(data.zonecode);
                $('#roadAddress').val(data.roadAddress);
                $('#jibunAddress').val(data.jibunAddress);

                // 기본 주소 선택 (도로명 우선, 없으면 지번)
                const baseAddress = data.roadAddress || data.jibunAddress;
                $('#address').val(baseAddress);
                $('#roadAddress').removeClass('is-invalid');

                // 좌표 변환
                getCoordinates(baseAddress);

                // 상세주소 입력란으로 포커스 이동
                $('#detailAddress').focus();
            }
        }).open();
    });
});

// 회사 정보 로드 함수
function loadCompanyInfo() {
    $.ajax({
        url: '/api/v1/admin/company/info',
        method: 'GET',
        success: function(data) {
            // 폼 필드에 데이터 채우기
            $('#businessName').val(data.businessName || '');

            // 주소 관련 필드
            $('#postalCode').val(data.postalCode || '');
            $('#roadAddress').val(data.roadAddress || '');
            $('#jibunAddress').val(data.jibunAddress || '');
            $('#address').val(data.address || '');
            $('#detailAddress').val(data.detailAddress || '');
            $('#latitude').val(data.latitude || '');
            $('#longitude').val(data.longitude || '');

            $('#directions').val(data.directions || '');
            $('#phoneNumber').val(data.phoneNumber || '');
            $('#faxNumber').val(data.faxNumber || '');
            $('#managerPosition').val(data.managerPosition || '');
            $('#managerName').val(data.managerName || '');
            $('#managerPhone').val(data.managerPhone || '');
            $('#managerEmail').val(data.managerEmail || '');

            // 담당자 사진 미리보기
            if (data.managerPhoto) {
                $('#previewImage').attr('src', data.managerPhoto);
                $('#photoPreview').show();
            }
        },
        error: function(xhr, status, error) {
            console.error('회사 정보 로드 실패:', error);
            // 에러 발생 시 기본값 유지 (서버의 getDefaultCompanyInfo가 반환됨)
        }
    });
}

function validateForm() {
    const requiredFields = ['businessName', 'phoneNumber', 'address', 'managerName', 'managerPhone'];
    let isValid = true;

    requiredFields.forEach(function(fieldName) {
        const field = $(`[name="${fieldName}"]`);
        if (!field.val().trim()) {
            field.addClass('is-invalid');
            isValid = false;
        } else {
            field.removeClass('is-invalid');
        }
    });

    if (!isValid) {
        $(document).Toasts('create', {
            class: 'bg-warning',
            title: '입력 오류',
            body: '필수 항목을 모두 입력해주세요.',
            autohide: true,
            delay: 3000
        });
    }

    return isValid;
}

function resetForm() {
    if (confirm('모든 변경사항이 초기화됩니다. 계속하시겠습니까?')) {
        document.getElementById('companyInfoForm').reset();
        $('#photoPreview').hide();
        $('.custom-file-label').removeClass("selected").html("파일 선택");
        $('.form-control').removeClass('is-invalid');
    }
}

// 좌표 가져오기 (Kakao Maps Geocoder 사용)
function getCoordinates(address) {
    $.ajax({
        url: 'https://dapi.kakao.com/v2/local/search/address.json',
        type: 'GET',
        headers: {
            'Authorization': 'f6bac5696b9306e5fb34acef74db15b1'
        },
        data: {
            query: address
        },
        success: function(response) {
            if (response.documents && response.documents.length > 0) {
                const result = response.documents[0];
                $('#latitude').val(result.y);
                $('#longitude').val(result.x);
                console.log('좌표 설정 완료:', result.y, result.x);
            } else {
                // 좌표를 찾을 수 없는 경우 null로 저장
                $('#latitude').val('');
                $('#longitude').val('');
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: '알림',
                        text: '정확한 좌표를 찾을 수 없습니다.',
                        timer: 2000
                    });
                }
                console.log('좌표를 찾을 수 없어 null로 저장');
            }
        },
        error: function() {
            // API 호출 실패시 null로 저장
            $('#latitude').val('');
            $('#longitude').val('');
            console.log('좌표 API 호출 실패, null로 저장');
        }
    });
}
/*]]>*/
</script>
</th:block>
</html>
