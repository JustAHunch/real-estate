<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin/layout}" lang="ko">

<th:block layout:fragment="styles">
    <!-- Select2 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    <!-- Summernote -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-bs4.min.css">
</th:block>

<div layout:fragment="content">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">매물 수정</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> 홈</a></li>
                        <li class="breadcrumb-item"><a href="/admin/properties/list">매물 목록</a></li>
                        <li class="breadcrumb-item active">매물 수정</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Alert for unsaved changes -->
            <div class="alert alert-info alert-dismissible" id="unsavedAlert" style="display: none;">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <h5><i class="icon fas fa-info"></i> 알림!</h5>
                변경사항이 있습니다. 저장하지 않으면 변경사항이 손실됩니다.
            </div>

            <form id="propertyEditForm" method="post" enctype="multipart/form-data">
                <input type="hidden" name="propertyId" th:value="${propertyId}" id="propertyId">

                <div class="row">
                    <!-- 기본 정보 카드 -->
                    <div class="col-md-8">
                        <div class="card card-primary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-edit mr-1"></i>
                                    매물 기본 정보
                                </h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="propertyName">매물명 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="propertyName" name="propertyName"
                                                   
                                                   placeholder="매물명을 입력하세요" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="propertyType">매물 종류 <span class="text-danger">*</span></label>
                                            <select class="form-control select2" id="propertyType" name="propertyType" required>
                                                <option value="">매물 종류 선택</option>
                                                <option value="APARTMENT" >아파트</option>
                                                <option value="VILLA" >빌라</option>
                                                <option value="ONE_ROOM" >원룸</option>
                                                <option value="TWOTHREE_ROOM" >투룸/쓰리룸</option>
                                                <option value="COMMERCIAL" >상가/사무실</option>
                                                <option value="STORE" >점포</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="address">주소 <span class="text-danger">*</span></label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="postalCode" name="postalCode"
                                                placeholder="우편번호" readonly>
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" type="button" id="searchAddress">
                                                <i class="fas fa-search"></i> 주소 검색
                                            </button>
                                        </div>
                                    </div>
                                    <input type="text" class="form-control mb-2" id="roadAddress" name="roadAddress"
                                            placeholder="도로명 주소" readonly>
                                    <input type="text" class="form-control mb-2" id="jibunAddress" name="jibunAddress"
                                            placeholder="지번 주소" readonly>
                                    <input type="text" class="form-control" id="address" name="address"
                                            placeholder="기본 주소 (자동입력)" readonly required>
                                    <!-- Hidden fields for coordinates -->
                                    <input type="hidden" id="latitude" name="latitude" >
                                    <input type="hidden" id="longitude" name="longitude" >
                                </div>

                                <div class="form-group">
                                    <label for="detailAddress">상세 주소</label>
                                    <input type="text" class="form-control" id="detailAddress" name="detailAddress"
                                            placeholder="상세 주소를 입력하세요 (예: 101호)">
                                </div>

                                <!-- 동적 필드 컨테이너 -->
                                <div id="dynamicFields"></div>
                            </div>
                        </div>

                        <!-- 가격 정보 카드 -->
                        <div class="card card-warning card-outline">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-won-sign mr-1"></i>
                                    가격 정보
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="transactionType">거래 종류 <span class="text-danger">*</span></label>
                                            <select class="form-control select2" id="transactionType" name="transactionType" required>
                                                <option value="">거래 종류 선택</option>
                                                <option value="매매" >매매</option>
                                                <option value="전세" >전세</option>
                                                <option value="월세" >월세</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="price">가격 (만원) <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="price" name="price"
                                                   
                                                   placeholder="0" min="0" required>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="deposit">보증금 (만원)</label>
                                            <input type="number" class="form-control" id="deposit" name="deposit"
                                                   
                                                   placeholder="0" min="0">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="monthlyRent">월세 (만원)</label>
                                            <input type="number" class="form-control" id="monthlyRent" name="monthlyRent"
                                                   
                                                   placeholder="0" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 상세 설명 카드 -->
                        <div class="card card-info card-outline">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-align-left mr-1"></i>
                                    상세 설명
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="description">매물 설명</label>
                                    <textarea id="summernote" name="description" >
                                        <p>강남역 도보 3분 거리의 프리미엄 오피스텔입니다.</p>
                                        <ul>
                                            <li>최고급 마감재 사용</li>
                                            <li>넓은 발코니와 전망</li>
                                            <li>편리한 교통 접근성</li>
                                        </ul>
                                    </textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 우측 사이드바 -->
                    <div class="col-md-4">
                        <!-- 매물 상태 카드 -->
                        <div class="card card-success card-outline">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    매물 상태
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="status">상태</label>
                                    <select class="form-control select2" id="status" name="status">
                                        <option value="AVAILABLE" >판매중</option>
                                        <option value="RESERVED" >예약중</option>
                                        <option value="SOLD" >거래완료</option>
                                        <option value="HIDDEN" >숨김</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="featured">추천 매물</label>
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="featured" name="featured"
                                               >
                                        <label class="custom-control-label" for="featured">메인 페이지에 노출</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 이미지 관리 카드 -->
                        <div class="card card-secondary card-outline">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-images mr-1"></i>
                                    이미지 관리
                                </h3>
                            </div>
                            <div class="card-body">
                                <!-- 기존 이미지 목록 -->
                                <div id="existingImages" class="mb-3">
                                    <div class="image-item mb-2" >
                                        <div class="card">
                                            <img  src="/images/beom_logo.png" class="card-img-top" alt="매물 이미지">
                                            <div class="card-body p-2">
                                                <button type="button" class="btn btn-danger btn-sm btn-block"
                                                        onclick="removeImage(this)" >
                                                    <i class="fas fa-trash"></i> 삭제
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 샘플 이미지 (실제 데이터가 없을 때) -->
                                    <div class="image-item mb-2">
                                        <div class="card">
                                            <img src="/images/beom_logo.png" class="card-img-top" alt="매물 이미지">
                                            <div class="card-body p-2">
                                                <button type="button" class="btn btn-danger btn-sm btn-block" onclick="removeImage(this)">
                                                    <i class="fas fa-trash"></i> 삭제
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 새 이미지 업로드 -->
                                <div class="form-group">
                                    <label for="newImages">새 이미지 추가</label>
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="newImages" name="newImages"
                                               multiple accept="image/*">
                                        <label class="custom-file-label" for="newImages">파일 선택</label>
                                    </div>
                                    <small class="form-text text-muted">JPG, PNG 파일만 업로드 가능합니다.</small>
                                </div>
                                <div id="newImagePreviews"></div>
                            </div>
                        </div>

                        <!-- 액션 버튼 카드 -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg btn-block">
                                        <i class="fas fa-save"></i> 수정 저장
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-lg btn-block" onclick="history.back()">
                                        <i class="fas fa-arrow-left"></i> 목록으로 돌아가기
                                    </button>
                                    <hr>
                                    <button type="button" class="btn btn-danger btn-lg btn-block" id="deletePropertyBtn">
                                        <i class="fas fa-trash"></i> 매물 삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

<th:block layout:fragment="scripts">
    <!-- Summernote -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-bs4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/lang/summernote-ko-KR.min.js"></script>
    <!-- Daum Postcode API -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script>
    /*<![CDATA[*/
    $(document).ready(function() {
        let hasUnsavedChanges = false;
        const propertyId = $('#propertyId').val();

        // 매물 데이터 로드
        if (propertyId) {
            loadPropertyData(propertyId);
        }

        // Select2 초기화
        $('.select2').select2({
            theme: 'bootstrap',
            placeholder: '선택하세요',
            allowClear: true
        });

        // Summernote 초기화
        $('#summernote').summernote({
            height: 300,
            lang: 'ko-KR',
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture', 'video']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            callbacks: {
                onChange: function() {
                    hasUnsavedChanges = true;
                    $('#unsavedAlert').show();
                }
            }
        });

        // 파일 입력 라벨 업데이트
        $('.custom-file-input').on('change', function() {
            const fileName = $(this).val().split('\\').pop();
            const fileCount = this.files.length;
            const label = fileCount > 1 ? `${fileCount}개 파일 선택됨` : fileName;
            $(this).siblings('.custom-file-label').addClass("selected").html(label);

            // 새 이미지 미리보기
            showNewImagePreviews(this.files);
            hasUnsavedChanges = true;
            $('#unsavedAlert').show();
        });

        // 폼 변경 감지
        $('#propertyEditForm input, #propertyEditForm select').on('change', function() {
            hasUnsavedChanges = true;
            $('#unsavedAlert').show();
        });

        // 매물 종류 변경시 동적 필드 로드
        $('#propertyType').on('change', function() {
            const propertyType = $(this).val();
            if (propertyType) {
                loadDynamicFields(propertyType);
            } else {
                $('#dynamicFields').empty();
            }
        });

        // 초기 로드시 동적 필드 설정
        const initialType = $('#propertyType').val();
        if (initialType) {
            loadDynamicFields(initialType);
        }

        // 폼 제출 처리
        $('#propertyEditForm').on('submit', function(e) {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            Swal.fire({
                title: '매물 정보 수정',
                text: '매물 정보를 수정하시겠습니까?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#007bff',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '수정',
                cancelButtonText: '취소'
            }).then((result) => {
                if (result.isConfirmed) {
                    submitForm();
                }
            });
        });

        // 삭제 버튼 클릭
        $('#deletePropertyBtn').on('click', function() {
            Swal.fire({
                title: '매물 삭제',
                text: '정말로 이 매물을 삭제하시겠습니까? 삭제된 매물은 복구할 수 없습니다.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '삭제',
                cancelButtonText: '취소'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteProperty();
                }
            });
        });

        // 주소 검색 초기화
        $('#searchAddress').on('click', function() {
            new daum.Postcode({
                oncomplete: function(data) {
                    // 우편번호와 주소 정보를 입력
                    $('#postalCode').val(data.zonecode);
                    $('#roadAddress').val(data.roadAddress);
                    $('#jibunAddress').val(data.jibunAddress);

                    // 기본 주소 선택 (도로명 우선, 없으면 지번)
                    const baseAddress = data.roadAddress || data.jibunAddress;
                    $('#address').val(baseAddress);
                    $('#address').removeClass('is-invalid');

                    // 좌표 변환
                    getCoordinates(baseAddress);

                    // 상세주소 입력란으로 포커스 이동
                    $('#detailAddress').focus();

                    hasUnsavedChanges = true;
                    $('#unsavedAlert').show();
                }
            }).open();
        });

        // 페이지 벗어날 때 경고
        $(window).on('beforeunload', function() {
            if (hasUnsavedChanges) {
                return '변경사항이 저장되지 않았습니다. 페이지를 떠나시겠습니까?';
            }
        });
    });

    // 매물 데이터 로드
    function loadPropertyData(propertyId) {
        // 로딩 표시
        Swal.fire({
            title: '매물 정보 불러오는 중...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        $.ajax({
            url: `/api/v1/admin/properties/${propertyId}`,
            method: 'GET',
            success: function(property) {
                Swal.close(); // 로딩 닫기

                // 기본 정보
                $('#propertyName').val(property.propertyName || '');
                $('#propertyType').val(property.propertyType || '').trigger('change');

                // 주소 정보
                $('#postalCode').val(property.postalCode || '');
                $('#roadAddress').val(property.roadAddress || '');
                $('#jibunAddress').val(property.jibunAddress || '');
                $('#address').val(property.address || '');
                $('#detailAddress').val(property.detailAddress || '');
                $('#latitude').val(property.latitude || '');
                $('#longitude').val(property.longitude || '');

                // 가격 정보
                $('#transactionType').val(property.transactionType || '').trigger('change');
                $('#price').val(property.price || 0);
                $('#deposit').val(property.deposit || 0);
                $('#monthlyRent').val(property.monthlyRent || 0);

                // 추가 필드 로드 (areaPyeong, floor, direction, etc.)
                if (property.areaPyeong) {
                    $('[name="areaPyeong"]').val(property.areaPyeong);
                }
                if (property.floor) {
                    $('[name="floor"]').val(property.floor);
                }
                if (property.direction) {
                    $('[name="direction"]').val(property.direction);
                }
                if (property.heatingType) {
                    $('[name="heatingType"]').val(property.heatingType);
                }
                if (property.bathroom) {
                    $('[name="bathroom"]').val(property.bathroom);
                }
                if (property.buildingUsage) {
                    $('[name="buildingUsage"]').val(property.buildingUsage);
                }
                if (property.moveInType) {
                    $('[name="moveInType"]').val(property.moveInType);
                }
                if (property.maintenanceFee) {
                    $('[name="maintenanceFee"]').val(property.maintenanceFee);
                }

                // 상세 설명
                if (property.description) {
                    $('#summernote').summernote('code', property.description);
                }

                // 상태 정보
                $('#status').val(property.status || 'AVAILABLE').trigger('change');
                if (property.featured) {
                    $('#featured').prop('checked', true);
                }

                // 동적 필드가 있는 경우 처리
                if (property.propertyType) {
                    // 동적 필드 로드 후 값 설정
                    loadDynamicFieldsForEdit(property.propertyType, property);
                }

                // 이미지 로드
                if (property.images && property.images.length > 0) {
                    loadExistingImages(property.images);
                }

                console.log('매물 데이터 로드 완료:', property);
            },
            error: function(xhr) {
                Swal.close();
                console.error('매물 데이터 로드 실패:', xhr);
                Swal.fire({
                    icon: 'error',
                    title: '오류',
                    text: '매물 정보를 불러오는데 실패했습니다.'
                }).then(() => {
                    window.location.href = '/admin/properties/list';
                });
            }
        });
    }

    // edit 페이지용 동적 필드 로드 (데이터 포함)
    function loadDynamicFieldsForEdit(propertyType, propertyData) {
        $.ajax({
            url: '/api/v1/admin/properties/property-type-fields',
            method: 'GET',
            data: { type: propertyType },
            success: function(response) {
                let fieldsHtml = '<div class="row">';

                response.fields.forEach(function(field, index) {
                    if (index % 2 === 0 && index > 0) {
                        fieldsHtml += '</div><div class="row">';
                    }

                    const fieldValue = propertyData[field.fieldName] || '';

                    fieldsHtml += `<div class="col-md-6">
                        <div class="form-group">
                            <label for="${field.fieldName}">${field.displayName}</label>`;

                    if (field.fieldType === 'SELECT') {
                        fieldsHtml += `<select class="form-control" id="${field.fieldName}" name="${field.fieldName}">
                            <option value="">선택하세요</option>`;
                        field.options.forEach(function(option) {
                            const selected = fieldValue === option ? 'selected' : '';
                            fieldsHtml += `<option value="${option}" ${selected}>${option}</option>`;
                        });
                        fieldsHtml += '</select>';
                    } else {
                        fieldsHtml += `<input type="${field.fieldType.toLowerCase()}"
                            class="form-control" id="${field.fieldName}" name="${field.fieldName}"
                            value="${fieldValue}">`;
                    }

                    fieldsHtml += '</div></div>';
                });

                fieldsHtml += '</div>';
                $('#dynamicFields').html(fieldsHtml);
            },
            error: function(xhr) {
                console.error('동적 필드 로드 실패:', xhr.responseText);
            }
        });
    }

    // 기존 이미지 로드
    function loadExistingImages(images) {
        const container = $('#existingImages');
        container.empty();

        images.forEach(function(imageUrl) {
            const imageHtml = `
                <div class="image-item mb-2">
                    <div class="card">
                        <img src="${imageUrl}" class="card-img-top" alt="매물 이미지" style="height: 150px; object-fit: cover;">
                        <div class="card-body p-2">
                            <button type="button" class="btn btn-danger btn-sm btn-block" onclick="removeExistingImage(this, '${imageUrl}')">
                                <i class="fas fa-trash"></i> 삭제
                            </button>
                        </div>
                    </div>
                </div>`;
            container.append(imageHtml);
        });
    }

    // 기존 이미지 삭제
    window.removeExistingImage = function(button, imageUrl) {
        Swal.fire({
            title: '이미지 삭제',
            text: '이 이미지를 삭제하시겠습니까?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '삭제',
            cancelButtonText: '취소'
        }).then((result) => {
            if (result.isConfirmed) {
                $(button).closest('.image-item').remove();
                hasUnsavedChanges = true;
                $('#unsavedAlert').show();
            }
        });
    };

    // 좌표 가져오기 (Kakao Maps Geocoder 사용)
    function getCoordinates(address) {
        $.ajax({
            url: 'https://dapi.kakao.com/v2/local/search/address.json',
            type: 'GET',
            headers: {
                'Authorization': 'f6bac5696b9306e5fb34acef74db15b1'
            },
            data: {
                query: address
            },
            success: function(response) {
                if (response.documents && response.documents.length > 0) {
                    const result = response.documents[0];
                    $('#latitude').val(result.y);
                    $('#longitude').val(result.x);
                    console.log('좌표 설정 완료:', result.y, result.x);
                } else {
                    // 좌표를 찾을 수 없는 경우 기본값 설정 (창원시청 좌표)
                    $('#latitude').val('35.2276');
                    $('#longitude').val('128.6811');
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'warning',
                            title: '알림',
                            text: '정확한 좌표를 찾을 수 없어 기본 좌표로 설정됩니다.',
                            timer: 2000
                        });
                    }
                }
            },
            error: function() {
                // API 호출 실패시 기본 좌표 사용
                $('#latitude').val('35.2276');
                $('#longitude').val('128.6811');
                console.log('좌표 API 호출 실패, 기본 좌표 사용');
            }
        });
    }

    // 동적 필드 로드
    function loadDynamicFields(propertyType) {
        $.ajax({
            url: '/api/v1/admin/properties/property-type-fields',
            method: 'GET',
            data: { type: propertyType },
            success: function(response) {
                let fieldsHtml = '<div class="row">';

                response.fields.forEach(function(field, index) {
                    if (index % 2 === 0 && index > 0) {
                        fieldsHtml += '</div><div class="row">';
                    }

                    fieldsHtml += `<div class="col-md-6">
                        <div class="form-group">
                            <label for="${field.fieldName}">${field.displayName}</label>`;

                    if (field.fieldType === 'SELECT') {
                        fieldsHtml += `<select class="form-control" id="${field.fieldName}" name="${field.fieldName}">
                            <option value="">선택하세요</option>`;
                        field.options.forEach(function(option) {
                            fieldsHtml += `<option value="${option}">${option}</option>`;
                        });
                        fieldsHtml += '</select>';
                    } else {
                        fieldsHtml += `<input type="${field.fieldType.toLowerCase()}"
                            class="form-control" id="${field.fieldName}" name="${field.fieldName}">`;
                    }

                    fieldsHtml += '</div></div>';
                });

                fieldsHtml += '</div>';
                $('#dynamicFields').html(fieldsHtml);
            },
            error: function(xhr) {
                console.error('동적 필드 로드 실패:', xhr.responseText);
            }
        });
    }

    // 새 이미지 미리보기
    function showNewImagePreviews(files) {
        const container = $('#newImagePreviews');
        container.empty();

        Array.from(files).forEach(function(file, index) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewHtml = `
                        <div class="image-preview-item mb-2">
                            <div class="card">
                                <img src="${e.target.result}" class="card-img-top" alt="새 이미지" style="height: 150px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <small class="text-muted">${file.name}</small>
                                </div>
                            </div>
                        </div>`;
                    container.append(previewHtml);
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // 기존 이미지 삭제
    function removeImage(button) {
        Swal.fire({
            title: '이미지 삭제',
            text: '이 이미지를 삭제하시겠습니까?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '삭제',
            cancelButtonText: '취소'
        }).then((result) => {
            if (result.isConfirmed) {
                $(button).closest('.image-item').remove();
                hasUnsavedChanges = true;
                $('#unsavedAlert').show();

                Swal.fire('삭제 완료', '이미지가 삭제되었습니다.', 'success');
            }
        });
    }

    // 폼 유효성 검사
    function validateForm() {
        let isValid = true;
        const requiredFields = ['propertyName', 'propertyType', 'address', 'transactionType', 'price'];

        requiredFields.forEach(function(fieldName) {
            const field = $(`[name="${fieldName}"]`);
            if (!field.val() || field.val().trim() === '') {
                field.addClass('is-invalid');
                isValid = false;
            } else {
                field.removeClass('is-invalid');
            }
        });

        if (!isValid) {
            Swal.fire({
                title: '입력 오류',
                text: '필수 항목을 모두 입력해주세요.',
                icon: 'warning'
            });
        }

        return isValid;
    }

    // 폼 제출
    function submitForm() {
        const formData = new FormData($('#propertyEditForm')[0]);

        // 로딩 표시
        Swal.fire({
            title: '매물 정보 수정 중...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading()
            }
        });

        // AJAX 요청 (실제 구현시)
        setTimeout(() => {
            Swal.fire({
                title: '수정 완료',
                text: '매물 정보가 성공적으로 수정되었습니다.',
                icon: 'success'
            }).then(() => {
                hasUnsavedChanges = false;
                window.location.href = '/admin/properties/list';
            });
        }, 1500);
    }

    // 매물 삭제
    function deleteProperty() {
        // 로딩 표시
        Swal.fire({
            title: '매물 삭제 중...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading()
            }
        });

        // AJAX 요청 (실제 구현시)
        setTimeout(() => {
            Swal.fire({
                title: '삭제 완료',
                text: '매물이 성공적으로 삭제되었습니다.',
                icon: 'success'
            }).then(() => {
                hasUnsavedChanges = false;
                window.location.href = '/admin/properties/list';
            });
        }, 1500);
    }
    /*]]>*/
    </script>
</th:block>
</html>
