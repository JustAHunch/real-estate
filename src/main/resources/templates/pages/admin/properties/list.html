<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin/layout}">

<th:block layout:fragment="styles">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap4.min.css">
    <!-- Ekko Lightbox -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.css">

    <style>
        .property-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        .property-image:hover {
            transform: scale(1.1);
        }
        .status-badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            font-weight: 600;
        }
        .badge-status-available {
            background-color: #28a745;
            color: white;
        }
        .badge-status-reserved {
            background-color: #ffc107;
            color: #212529;
        }
        .badge-status-sold {
            background-color: #6c757d;
            color: white;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .table-toolbar {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .btn-group-export {
            margin-left: auto;
        }
    </style>
</th:block>

<!-- Content Header -->
<div layout:fragment="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1><i class="fas fa-building mr-2"></i>매물 목록</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> 홈</a></li>
                    <li class="breadcrumb-item">매물관리</li>
                    <li class="breadcrumb-item active">매물 목록</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div layout:fragment="content">
            <!-- 필터 섹션 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-filter mr-2"></i>검색 필터</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterType">매물 종류</label>
                                <select class="form-control" id="filterType">
                                    <option value="">전체 종류</option>
                                    <option value="APARTMENT">아파트</option>
                                    <option value="VILLA">빌라</option>
                                    <option value="ONE_ROOM">원룸</option>
                                    <option value="TWOTHREE_ROOM">투룸/쓰리룸</option>
                                    <option value="COMMERCIAL">상가/사무실</option>
                                    <option value="STORE">점포</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterTransaction">거래 유형</label>
                                <select class="form-control" id="filterTransaction">
                                    <option value="">전체 거래</option>
                                    <option value="SALE">매매</option>
                                    <option value="JEONSE">전세</option>
                                    <option value="MONTHLY">월세</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="searchKeyword">키워드 검색</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchKeyword" placeholder="주소, 매물명...">
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="button" id="btnSearch">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 매물 목록 카드 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-list mr-2"></i>전체 매물 목록</h3>
                    <div class="card-tools">
                        <a href="/admin/properties/register" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus mr-1"></i>매물 등록
                        </a>
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 툴바 -->
                    <div class="table-toolbar mb-3">
                        <div class="btn-group btn-group-export">
                            <button type="button" class="btn btn-secondary btn-sm" id="btnExcelExport">
                                <i class="fas fa-file-excel mr-1"></i>Excel
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="btnPdfExport">
                                <i class="fas fa-file-pdf mr-1"></i>PDF
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="btnPrint">
                                <i class="fas fa-print mr-1"></i>인쇄
                            </button>
                        </div>
                    </div>

                    <!-- 테이블 -->
                    <div class="table-responsive">
                        <table id="propertiesTable" class="table table-bordered table-hover table-striped">
                            <thead class="thead-light">
                                <tr>
                                    <th>주소</th>
                                    <th width="100">종류</th>
                                    <th width="120">거래유형</th>
                                    <th width="140">가격</th>
                                    <th width="100">평수</th>
                                    <th width="120">등록일</th>
                                    <th width="120">관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- AJAX로 로드됨 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
</div>

<!-- Scripts -->
<th:block layout:fragment="scripts">
    <!-- DataTables Buttons extension (DataTables 기본은 fragments/scripts.html에 이미 로드됨) -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <!-- Ekko Lightbox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js"></script>

    <script>
    /*<![CDATA[*/
    $(document).ready(function() {
        // 커스텀 필터 변수
        let currentFilters = {
            type: '',
            transactionType: '',
            keyword: ''
        };

        // DataTables 초기화 (AJAX)
        const table = $('#propertiesTable').DataTable({
            responsive: true,
            processing: true,
            serverSide: true,
            ajax: {
                url: '/api/v1/admin/properties',
                type: 'GET',
                data: function(d) {
                    // DataTables 파라미터를 Spring Pageable 형식으로 변환
                    return {
                        page: Math.floor(d.start / d.length),
                        size: d.length,
                        type: currentFilters.type,
                        transactionType: currentFilters.transactionType,
                        keyword: currentFilters.keyword
                    };
                },
                dataSrc: function(json) {
                    // Spring PagingResult를 DataTables 형식으로 변환
                    json.recordsTotal = json.totalElements || 0;
                    json.recordsFiltered = json.totalElements || 0;
                    return json.content || [];
                }
            },
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ko.json'
            },
            pageLength: 10,
            lengthMenu: [/*[+*/ [10, 25, 50, 100], ["10", "25", "50", "100"] /*+]*/],
            order: [/*[+*/ [5, 'desc'] /*+]*/], // 등록일 기준 내림차순
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
            columns: [
                {
                    data: 'address',
                    render: function(data, type, row) {
                        return '<div class="property-info">' +
                               '<strong>' + (row.detailAddress || '') + '</strong><br>' +
                               '<small class="text-muted">' + data + '</small>' +
                               '</div>';
                    }
                },
                {
                    data: 'propertyType',
                    render: function(data) {
                        const typeMap = {
                            'APARTMENT': '아파트',
                            'VILLA': '빌라',
                            'ONE_ROOM': '원룸',
                            'TWOTHREE_ROOM': '투룸/쓰리룸',
                            'COMMERCIAL': '상가/사무실',
                            'STORE': '점포'
                        };
                        const badgeColors = {
                            'APARTMENT': 'primary',
                            'VILLA': 'success',
                            'ONE_ROOM': 'info',
                            'TWOTHREE_ROOM': 'warning',
                            'COMMERCIAL': 'info',
                            'STORE': 'warning'
                        };
                        return '<span class="badge badge-' + (badgeColors[data] || 'secondary') + '">' +
                               (typeMap[data] || data) + '</span>';
                    }
                },
                {
                    data: 'transactionType',
                    render: function(data) {
                        const typeMap = {
                            'SALE': '매매',
                            'JEONSE': '전세',
                            'MONTHLY': '월세'
                        };
                        const badgeColors = {
                            'SALE': 'primary',
                            'JEONSE': 'success',
                            'MONTHLY': 'danger'
                        };
                        return '<span class="badge badge-' + (badgeColors[data] || 'secondary') + '">' +
                               (typeMap[data] || data) + '</span>';
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        if (row.transactionType === 'SALE') {
                            return '<span class="font-weight-bold text-success">' +
                                   formatPrice(row.price) + '</span>';
                        } else if (row.transactionType === 'JEONSE') {
                            return '<span class="font-weight-bold text-info">' +
                                   formatPrice(row.deposit) + '</span>';
                        } else if (row.transactionType === 'MONTHLY') {
                            return '<span class="font-weight-bold text-primary">' +
                                   formatPrice(row.deposit) + '/' + formatPrice(row.monthlyRent) + '</span>';
                        }
                        return '-';
                    }
                },
                {
                    data: 'areaPyeong',
                    render: function(data) {
                        return data ? data + '평' : '-';
                    }
                },
                {
                    data: 'createdAt',
                    render: function(data) {
                        return data ? new Date(data).toLocaleDateString('ko-KR') : '-';
                    }
                },
                {
                    data: 'id',
                    orderable: false,
                    searchable: false,
                    render: function(data) {
                        return '<div class="btn-group" role="group">' +
                               '<button class="btn btn-info btn-sm" onclick="viewProperty(\'' + data + '\')" title="상세보기">' +
                               '<i class="fas fa-eye"></i>' +
                               '</button>' +
                               '<button class="btn btn-warning btn-sm" onclick="editProperty(\'' + data + '\')" title="수정">' +
                               '<i class="fas fa-edit"></i>' +
                               '</button>' +
                               '<button class="btn btn-danger btn-sm" onclick="deleteProperty(\'' + data + '\')" title="삭제">' +
                               '<i class="fas fa-trash"></i>' +
                               '</button>' +
                               '</div>';
                    }
                }
            ],
            initComplete: function() {
                // 초기화 완료 후 커스텀 필터 이벤트 바인딩
                bindFilterEvents();
            }
        });

        // 가격 포맷 함수
        function formatPrice(price) {
            if (!price || price === 0) return '0원';

            const eok = Math.floor(price / 100000000);
            const man = Math.floor((price % 100000000) / 10000);

            let result = '';
            if (eok > 0) result += eok + '억';
            if (man > 0) result += ' ' + man + '만원';
            if (result === '') result = price.toLocaleString() + '원';

            return result.trim();
        }

        // 커스텀 필터 이벤트 바인딩
        function bindFilterEvents() {
            // 검색 버튼 클릭
            $('#btnSearch').on('click', function() {
                currentFilters.keyword = $('#searchKeyword').val();
                table.ajax.reload();
            });

            // 엔터키 검색
            $('#searchKeyword').on('keypress', function(e) {
                if (e.which === 13) {
                    currentFilters.keyword = $(this).val();
                    table.ajax.reload();
                }
            });

            // 필터 변경 시 검색
            $('#filterType, #filterTransaction').on('change', function() {
                currentFilters.type = $('#filterType').val();
                currentFilters.transactionType = $('#filterTransaction').val();
                table.ajax.reload();
            });
        }

        // 내보내기 버튼 이벤트
        $('#btnExcelExport').on('click', function() {
            table.button('.buttons-excel').trigger();
        });

        $('#btnPdfExport').on('click', function() {
            table.button('.buttons-pdf').trigger();
        });

        $('#btnPrint').on('click', function() {
            table.button('.buttons-print').trigger();
        });

        // Lightbox 초기화
        $(document).on('click', '[data-toggle="lightbox"]', function(event) {
            event.preventDefault();
            $(this).ekkoLightbox();
        });

        // 툴팁 초기화
        $('[title]').tooltip();
    });

    // 매물 관련 함수들
    function viewProperty(id) {
        window.open('/admin/properties/' + id, '_blank');
    }

    function editProperty(id) {
        window.location.href = '/admin/properties/edit/' + id;
    }

    function deleteProperty(id) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: '매물 삭제',
                text: '정말 이 매물을 삭제하시겠습니까?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '삭제',
                cancelButtonText: '취소'
            }).then((result) => {
                if (result.isConfirmed) {
                    // AJAX 삭제 요청
                    $.ajax({
                        url: '/api/v1/admin/properties/' + id,
                        method: 'DELETE',
                        success: function(response) {
                            Swal.fire('삭제완료', '매물이 성공적으로 삭제되었습니다.', 'success')
                                .then(() => location.reload());
                        },
                        error: function(xhr, status, error) {
                            Swal.fire('삭제실패', '매물 삭제 중 오류가 발생했습니다.', 'error');
                        }
                    });
                }
            });
        } else {
            if (confirm('정말 이 매물을 삭제하시겠습니까?')) {
                // AJAX 삭제 요청
                $.ajax({
                    url: '/api/v1/admin/properties/' + id,
                    method: 'DELETE',
                    success: function(response) {
                        alert('매물이 성공적으로 삭제되었습니다.');
                        location.reload();
                    },
                    error: function(xhr, status, error) {
                        alert('매물 삭제 중 오류가 발생했습니다.');
                    }
                });
            }
        }
    }
    /*]]>*/
    </script>
</th:block>
</html>