<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin/layout}">

<head>
    <title>매물 목록 - 범부동산</title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap4.min.css">

    <style>
        .property-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        .property-image:hover {
            transform: scale(1.1);
        }
        .status-badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            font-weight: 600;
        }
        .badge-status-available {
            background-color: #28a745;
            color: white;
        }
        .badge-status-reserved {
            background-color: #ffc107;
            color: #212529;
        }
        .badge-status-sold {
            background-color: #6c757d;
            color: white;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .table-toolbar {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .btn-group-export {
            margin-left: auto;
        }
    </style>
</head>

<body>
    <!-- Content Header -->
    <section layout:fragment="content-header" class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-building mr-2"></i>매물 목록</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/admin/dashboard">대시보드</a></li>
                        <li class="breadcrumb-item">매물관리</li>
                        <li class="breadcrumb-item active">매물 목록</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section layout:fragment="content" class="content">
        <div class="container-fluid">
            <!-- 필터 섹션 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-filter mr-2"></i>검색 필터</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterType">매물 종류</label>
                                <select class="form-control" id="filterType">
                                    <option value="">전체 종류</option>
                                    <option value="APARTMENT">아파트</option>
                                    <option value="VILLA">빌라</option>
                                    <option value="ONE_ROOM">원룸</option>
                                    <option value="TWOTHREE_ROOM">투룸/쓰리룸</option>
                                    <option value="COMMERCIAL">상가/사무실</option>
                                    <option value="STORE">점포</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterTransaction">거래 유형</label>
                                <select class="form-control" id="filterTransaction">
                                    <option value="">전체 거래</option>
                                    <option value="SALE">매매</option>
                                    <option value="JEONSE">전세</option>
                                    <option value="MONTHLY">월세</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterStatus">상태</label>
                                <select class="form-control" id="filterStatus">
                                    <option value="">전체 상태</option>
                                    <option value="available">판매중</option>
                                    <option value="reserved">예약중</option>
                                    <option value="sold">거래완료</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="searchKeyword">키워드 검색</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchKeyword" placeholder="주소, 매물명...">
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="button" id="btnSearch">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 매물 목록 카드 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-list mr-2"></i>전체 매물 목록</h3>
                    <div class="card-tools">
                        <a href="/admin/properties/register" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus mr-1"></i>매물 등록
                        </a>
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 툴바 -->
                    <div class="table-toolbar mb-3">
                        <div class="btn-group btn-group-export">
                            <button type="button" class="btn btn-secondary btn-sm" id="btnExcelExport">
                                <i class="fas fa-file-excel mr-1"></i>Excel
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="btnPdfExport">
                                <i class="fas fa-file-pdf mr-1"></i>PDF
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" id="btnPrint">
                                <i class="fas fa-print mr-1"></i>인쇄
                            </button>
                        </div>
                    </div>

                    <!-- 테이블 -->
                    <div class="table-responsive">
                        <table id="propertiesTable" class="table table-bordered table-hover table-striped">
                            <thead class="thead-light">
                                <tr>
                                    <th width="60">ID</th>
                                    <th width="100">이미지</th>
                                    <th>주소</th>
                                    <th width="100">종류</th>
                                    <th width="120">거래유형</th>
                                    <th width="120">가격</th>
                                    <th width="100">상태</th>
                                    <th width="120">등록일</th>
                                    <th width="120">관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 샘플 데이터 -->
                                <tr>
                                    <td>1</td>
                                    <td>
                                        <img src="/api/placeholder/80/60" alt="매물 이미지" class="property-image"
                                             data-toggle="lightbox" data-title="강남역 초역세권 오피스텔">
                                    </td>
                                    <td>
                                        <div class="property-info">
                                            <strong>강남역 초역세권 오피스텔</strong><br>
                                            <small class="text-muted">서울시 강남구 강남대로 123</small>
                                        </div>
                                    </td>
                                    <td><span class="badge badge-info">상가/사무실</span></td>
                                    <td><span class="badge badge-primary">매매</span></td>
                                    <td class="font-weight-bold text-success">5억 원</td>
                                    <td><span class="badge badge-status-available status-badge">판매중</span></td>
                                    <td>2025-10-15</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm" onclick="viewProperty('1')" title="상세보기">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="editProperty('1')" title="수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteProperty('1')" title="삭제">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>
                                        <img src="/api/placeholder/80/60" alt="매물 이미지" class="property-image"
                                             data-toggle="lightbox" data-title="홍대 상권 1층 상가">
                                    </td>
                                    <td>
                                        <div class="property-info">
                                            <strong>홍대 상권 1층 상가</strong><br>
                                            <small class="text-muted">서울시 마포구 홍익로 456</small>
                                        </div>
                                    </td>
                                    <td><span class="badge badge-warning">점포</span></td>
                                    <td><span class="badge badge-success">전세</span></td>
                                    <td class="font-weight-bold text-info">3억 원</td>
                                    <td><span class="badge badge-status-reserved status-badge">예약중</span></td>
                                    <td>2025-10-14</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm" onclick="viewProperty('2')" title="상세보기">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="editProperty('2')" title="수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteProperty('2')" title="삭제">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td>
                                        <img src="/api/placeholder/80/60" alt="매물 이미지" class="property-image"
                                             data-toggle="lightbox" data-title="신축 프리미엄 아파트">
                                    </td>
                                    <td>
                                        <div class="property-info">
                                            <strong>신축 프리미엄 아파트</strong><br>
                                            <small class="text-muted">서울시 송파구 잠실로 789</small>
                                        </div>
                                    </td>
                                    <td><span class="badge badge-primary">아파트</span></td>
                                    <td><span class="badge badge-danger">월세</span></td>
                                    <td class="font-weight-bold text-primary">300/50만원</td>
                                    <td><span class="badge badge-status-sold status-badge">거래완료</span></td>
                                    <td>2025-10-10</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm" onclick="viewProperty('3')" title="상세보기">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-warning btn-sm" onclick="editProperty('3')" title="수정">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteProperty('3')" title="삭제">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <th:block layout:fragment="scripts">
        <!-- DataTables -->
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
        <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
        <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>

        <!-- Buttons extension -->
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap4.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

        <!-- Ekko Lightbox -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js"></script>

        <script>
        $(document).ready(function() {
            // DataTables 초기화
            const table = $('#propertiesTable').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ko.json'
                },
                pageLength: 10,
                lengthMenu: [[10, 25, 50, 100], ["10", "25", "50", "100"]],
                order: [[0, 'desc']],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                columnDefs: [
                    {
                        targets: [1, 8], // 이미지, 관리 컬럼
                        orderable: false,
                        searchable: false
                    },
                    {
                        targets: [6], // 상태 컬럼
                        render: function(data, type, row) {
                            if (type === 'display') {
                                return data;
                            }
                            return data;
                        }
                    }
                ],
                initComplete: function() {
                    // 초기화 완료 후 커스텀 필터 이벤트 바인딩
                    bindFilterEvents();
                }
            });

            // 커스텀 필터 이벤트 바인딩
            function bindFilterEvents() {
                // 검색 버튼 클릭
                $('#btnSearch').on('click', function() {
                    const keyword = $('#searchKeyword').val();
                    table.search(keyword).draw();
                });

                // 엔터키 검색
                $('#searchKeyword').on('keypress', function(e) {
                    if (e.which === 13) {
                        const keyword = $(this).val();
                        table.search(keyword).draw();
                    }
                });

                // 필터 변경 시 검색
                $('#filterType, #filterTransaction, #filterStatus').on('change', function() {
                    applyFilters();
                });
            }

            // 필터 적용
            function applyFilters() {
                const typeFilter = $('#filterType').val();
                const transactionFilter = $('#filterTransaction').val();
                const statusFilter = $('#filterStatus').val();

                // 각 컬럼별 필터 적용
                table.columns(3).search(typeFilter); // 종류 컬럼
                table.columns(4).search(transactionFilter); // 거래유형 컬럼
                table.columns(6).search(statusFilter); // 상태 컬럼

                table.draw();
            }

            // 내보내기 버튼 이벤트
            $('#btnExcelExport').on('click', function() {
                table.button('.buttons-excel').trigger();
            });

            $('#btnPdfExport').on('click', function() {
                table.button('.buttons-pdf').trigger();
            });

            $('#btnPrint').on('click', function() {
                table.button('.buttons-print').trigger();
            });

            // Lightbox 초기화
            $(document).on('click', '[data-toggle="lightbox"]', function(event) {
                event.preventDefault();
                $(this).ekkoLightbox();
            });

            // 툴팁 초기화
            $('[title]').tooltip();
        });

        // 매물 관련 함수들
        function viewProperty(id) {
            window.open('/admin/properties/' + id, '_blank');
        }

        function editProperty(id) {
            window.location.href = '/admin/properties/edit/' + id;
        }

        function deleteProperty(id) {
            Swal.fire({
                title: '매물 삭제',
                text: '정말 이 매물을 삭제하시겠습니까?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: '삭제',
                cancelButtonText: '취소'
            }).then((result) => {
                if (result.isConfirmed) {
                    // AJAX 삭제 요청
                    $.ajax({
                        url: '/api/v1/admin/properties/' + id,
                        method: 'DELETE',
                        success: function(response) {
                            Swal.fire('삭제완료', '매물이 성공적으로 삭제되었습니다.', 'success')
                                .then(() => location.reload());
                        },
                        error: function(xhr, status, error) {
                            Swal.fire('삭제실패', '매물 삭제 중 오류가 발생했습니다.', 'error');
                        }
                    });
                }
            });
        }
        </script>
    </th:block>
</body>
</html>