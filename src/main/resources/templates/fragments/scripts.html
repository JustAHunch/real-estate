<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="scripts">
<body>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Bootstrap 4 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- AdminLTE App -->
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

<!-- Toastr -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- InputMask -->
<script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/jquery.inputmask.min.js"></script>

<!-- 공통 JavaScript -->
<script th:inline="javascript">
    $(document).ready(function() {
        // ==================== 사이드바 상태 관리 ====================
        $('[data-widget="pushmenu"]').on('click', function() {
            setTimeout(function() {
                var isCollapsed = $('body').hasClass('sidebar-collapse');
                localStorage.setItem('sidebarState', isCollapsed);
            }, 300);
        });

        // 저장된 사이드바 상태 복원
        var sidebarState = localStorage.getItem('sidebarState');
        if (sidebarState === 'true') {
            $('body').addClass('sidebar-collapse');
        }
        
        // ==================== DataTables 한국어 설정 ====================
        $.extend(true, $.fn.dataTable.defaults, {
            language: {
                "decimal": "",
                "emptyTable": "데이터가 없습니다.",
                "info": "_START_ - _END_ (총 _TOTAL_ 개)",
                "infoEmpty": "0개",
                "infoFiltered": "(전체 _MAX_ 개 중 검색결과)",
                "infoPostFix": "",
                "thousands": ",",
                "lengthMenu": "_MENU_ 개씩 보기",
                "loadingRecords": "로딩중...",
                "processing": "처리중...",
                "search": "검색:",
                "zeroRecords": "검색 결과가 없습니다.",
                "paginate": {
                    "first": "첫 페이지",
                    "last": "마지막 페이지",
                    "next": "다음",
                    "previous": "이전"
                },
                "aria": {
                    "sortAscending": ": 오름차순 정렬",
                    "sortDescending": ": 내림차순 정렬"
                }
            }
        });
        
        // ==================== Toastr 기본 설정 ====================
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };
        
        // ==================== Select2 초기화 ====================
        if ($.fn.select2) {
            $('.select2').select2({
                theme: 'bootstrap4',
                width: '100%',
                placeholder: '선택하세요',
                allowClear: true
            });
            
            $('.select2bs4').select2({
                theme: 'bootstrap4',
                width: '100%'
            });
        }
        
        // ==================== InputMask 초기화 ====================
        if ($.fn.inputmask) {
            $('[data-mask]').inputmask();
        }
        
        // ==================== 폼 Validation ====================
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                        showWarning('입력 항목을 확인해주세요.');
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
        
        // ==================== CSRF 토큰 설정 ====================
        // CSRF가 활성화된 경우에만 토큰을 설정합니다
        var csrfToken = /*[[${_csrf?.token}]]*/ '';
        var csrfHeader = /*[[${_csrf?.headerName}]]*/ '';
        if (csrfToken && csrfHeader) {
            $(document).ajaxSend(function(e, xhr, options) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
            });
        }
        
        // ==================== 툴팁 초기화 ====================
        $('[data-toggle="tooltip"]').tooltip();
        
        // ==================== 팝오버 초기화 ====================
        $('[data-toggle="popover"]').popover();
    });
    
    // ==================== 유틸리티 함수 ====================
    
    /**
     * 로딩 스피너 표시
     */
    function showLoading() {
        $('.loading-overlay').addClass('show');
    }
    
    /**
     * 로딩 스피너 숨김
     */
    function hideLoading() {
        $('.loading-overlay').removeClass('show');
    }
    
    /**
     * 성공 메시지 표시
     * @param {string} message - 표시할 메시지
     */
    function showSuccess(message) {
        toastr.success(message);
    }
    
    /**
     * 오류 메시지 표시
     * @param {string} message - 표시할 메시지
     */
    function showError(message) {
        toastr.error(message);
    }
    
    /**
     * 경고 메시지 표시
     * @param {string} message - 표시할 메시지
     */
    function showWarning(message) {
        toastr.warning(message);
    }
    
    /**
     * 정보 메시지 표시
     * @param {string} message - 표시할 메시지
     */
    function showInfo(message) {
        toastr.info(message);
    }
    
    /**
     * 확인 대화상자
     * @param {string} message - 확인 메시지
     * @param {function} callback - 확인 시 실행할 콜백 함수
     */
    function confirmAction(message, callback) {
        if (confirm(message)) {
            callback();
        }
    }
    
    /**
     * 숫자 포맷팅 (천단위 콤마)
     * @param {number} number - 포맷팅할 숫자
     * @returns {string} 포맷팅된 문자열
     */
    function formatNumber(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    /**
     * 날짜 포맷팅 (YYYY-MM-DD)
     * @param {Date} date - 포맷팅할 날짜 객체
     * @returns {string} 포맷팅된 날짜 문자열
     */
    function formatDate(date) {
        var d = new Date(date);
        var month = '' + (d.getMonth() + 1);
        var day = '' + d.getDate();
        var year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
    }
    
    /**
     * 날짜/시간 포맷팅 (YYYY-MM-DD HH:mm:ss)
     * @param {Date} date - 포맷팅할 날짜 객체
     * @returns {string} 포맷팅된 날짜/시간 문자열
     */
    function formatDateTime(date) {
        var d = new Date(date);
        return formatDate(d) + ' ' + 
               ('0' + d.getHours()).slice(-2) + ':' +
               ('0' + d.getMinutes()).slice(-2) + ':' +
               ('0' + d.getSeconds()).slice(-2);
    }
    
    /**
     * 파일 크기 포맷팅
     * @param {number} bytes - 바이트 단위 크기
     * @returns {string} 포맷팅된 파일 크기
     */
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    /**
     * Ajax 요청 (Promise 방식)
     * @param {string} url - 요청 URL
     * @param {string} method - HTTP 메서드 (GET, POST, PUT, DELETE)
     * @param {object} data - 전송할 데이터
     * @returns {Promise}
     */
    function ajaxRequest(url, method, data) {
        return new Promise(function(resolve, reject) {
            $.ajax({
                url: url,
                method: method,
                data: JSON.stringify(data),
                contentType: 'application/json',
                success: function(response) {
                    resolve(response);
                },
                error: function(xhr, status, error) {
                    reject(error);
                }
            });
        });
    }
    
    /**
     * 테이블 행 삭제 확인 후 실행
     * @param {string} url - 삭제 요청 URL
     * @param {string} message - 확인 메시지
     * @param {function} successCallback - 성공 시 콜백 함수
     */
    function deleteTableRow(url, message, successCallback) {
        confirmAction(message || '정말 삭제하시겠습니까?', function() {
            showLoading();
            $.ajax({
                url: url,
                method: 'DELETE',
                success: function(response) {
                    hideLoading();
                    showSuccess('삭제되었습니다.');
                    if (successCallback) successCallback(response);
                },
                error: function(xhr, status, error) {
                    hideLoading();
                    showError('삭제에 실패했습니다.');
                }
            });
        });
    }
</script>

<!-- 로딩 오버레이 -->
<div class="loading-overlay">
    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="sr-only">Loading...</span>
    </div>
</div>
</body>
</html>